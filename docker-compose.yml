# Royal Edinburgh Tattoo Trivia - Docker Compose Configuration
# =============================================================
# ROOTLESS DOCKER COMPATIBLE VERSION
# Uses named volumes to avoid permission issues
#
# Usage:
#   docker-compose up -d          # Start in background
#   docker-compose logs -f        # View logs
#   docker-compose down           # Stop and remove
#   docker-compose restart        # Restart service

version: '3.8'

services:
  trivia-game:
    # Service name - appears in logs and container name
    container_name: tattoo-trivia-game
    
    # Build configuration
    build:
      context: .
      dockerfile: Dockerfile
    
    # Image name and tag
    image: tattoo-trivia:latest
    
    # Port mapping: HOST:CONTAINER
    # Maps external port 13188 to internal port 3000
    ports:
      - "13188:3000"
    
    # Environment variables
    environment:
      - NODE_ENV=production
      - PORT=3000
      - TZ=Australia/Brisbane  # Set timezone for timestamps
    
    # Volume mounts for persistence
    # USING NAMED VOLUMES - Rootless Docker Compatible!
    volumes:
      # Persist game state and logs using named volumes
      # Named volumes are managed by Docker and avoid permission issues
      - game-data:/app
      - game-logs:/app/logs
      
      # Note: To access files from named volumes:
      # - View logs: docker-compose logs -f
      # - Copy state out: docker cp tattoo-trivia-game:/app/game-state.json ./
      # - Copy state in: docker cp ./game-state.json tattoo-trivia-game:/app/
      # - Shell access: docker-compose exec trivia-game sh
    
    # Restart policy
    # always: restart container automatically if it crashes or server reboots
    restart: always
    
    # Resource limits (optional but recommended)
    # Prevents container from consuming too many resources
    deploy:
      resources:
        limits:
          cpus: '0.5'      # Max 50% of one CPU core
          memory: 256M     # Max 256MB RAM
        reservations:
          cpus: '0.1'      # Minimum guaranteed
          memory: 64M      # Minimum guaranteed
    
    # Health check configuration
    # Automatically restarts if health check fails
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    
    # Logging configuration
    # Limits log file size to prevent disk fill-up
    logging:
      driver: "json-file"
      options:
        max-size: "10m"      # Maximum 10MB per log file
        max-file: "3"        # Keep 3 log files (30MB total)
        labels: "trivia-game"
    
    # Network configuration (optional)
    # Creates isolated network for the service
    networks:
      - trivia-network

# Network definition
networks:
  trivia-network:
    driver: bridge
    name: tattoo-trivia-network

# Named volume definitions
# These persist data independently of containers
# Managed by Docker, work perfectly with rootless Docker
volumes:
  game-data:
    name: tattoo-trivia-data
    driver: local
  game-logs:
    name: tattoo-trivia-logs
    driver: local

# ============================================
# ROOTLESS DOCKER NOTES
# ============================================
#
# Named volumes avoid permission issues because:
# - Docker manages the volume permissions
# - No host filesystem mapping required
# - Works with UID/GID namespace remapping
#
# To access data in named volumes:
#
# 1. View logs in real-time:
#    docker-compose logs -f
#
# 2. Copy game state out:
#    docker cp tattoo-trivia-game:/app/game-state.json ./game-state-backup.json
#
# 3. Copy game state in:
#    docker cp ./game-state-backup.json tattoo-trivia-game:/app/game-state.json
#    docker-compose restart
#
# 4. View game state:
#    docker-compose exec trivia-game cat /app/game-state.json
#
# 5. Reset game:
#    docker-compose exec trivia-game rm -f /app/game-state.json
#    docker-compose restart
#
# 6. Access container shell:
#    docker-compose exec trivia-game sh
#
# 7. View application logs:
#    docker-compose exec trivia-game cat /app/logs/game.log
#    docker-compose exec trivia-game tail -f /app/logs/game.log
#
# 8. Inspect volume location:
#    docker volume inspect tattoo-trivia-data
#    docker volume inspect tattoo-trivia-logs
#
# ============================================
# QUICK REFERENCE COMMANDS
# ============================================
#
# Start the service:
#   docker-compose up -d
#
# View logs (live):
#   docker-compose logs -f
#
# View logs (last 100 lines):
#   docker-compose logs --tail=100
#
# Check status:
#   docker-compose ps
#
# Restart service:
#   docker-compose restart
#
# Stop service:
#   docker-compose stop
#
# Stop and remove containers:
#   docker-compose down
#
# Stop and remove containers + volumes:
#   docker-compose down -v
#
# Rebuild and restart:
#   docker-compose up -d --build
#
# Access container shell:
#   docker-compose exec trivia-game sh
#
# View resource usage:
#   docker stats tattoo-trivia-game
#
# Backup game state:
#   docker cp tattoo-trivia-game:/app/game-state.json ./backup-$(date +%Y%m%d).json
#
# Restore game state:
#   docker cp ./backup.json tattoo-trivia-game:/app/game-state.json
#   docker-compose restart
#
# ============================================
# ACCESSING THE GAME
# ============================================
#
# After starting, access at:
#   http://YOUR_SERVER_IP:13188
#
# Player URLs:
#   http://YOUR_SERVER_IP:13188/game?player=lachlan
#   http://YOUR_SERVER_IP:13188/game?player=leigh
#
# With nginx/SSL:
#   https://130188.resuseducation.com/game?player=lachlan
#   https://130188.resuseducation.com/game?player=leigh
#
# ============================================
